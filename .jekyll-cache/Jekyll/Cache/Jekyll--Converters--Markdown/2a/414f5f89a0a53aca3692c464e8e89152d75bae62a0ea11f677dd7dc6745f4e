I"â <h3 id="kotlin-singleton-example-with-mvvm-and-coroutines">Kotlin Singleton Example with MVVM and coroutines<br /></h3>

<p>ì´ë²ˆ Postì— ì •ë¦¬í•  ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.<br />
2 examples :<br /></p>

<p>1) Quick â€œhow toâ€<br /></p>

<p>2)Practical example<br />
-Retrofit<br />
-Coroutines<br />
-MVVM<br /></p>

<p>Singletons</p>

<p>Instance of an object <br />
reuse the instance <br />
Retrofit instance <br />
Repository instance <br />
User sessions <br />
Dagger(Dependency Injection/Provide Singleton)
Daggerë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì¢€ ì–´ë µë‹¤. ë‚˜ì¤‘ì— ë³„ë„ì˜ ê°•ì˜ë¡œ ì´í•´í•˜ë„ë¡ í•˜ì.<br /></p>

<p><strong><font color="Red">ì ì´ì œ ì‹¤ì œë¡œ Singleton íŒ¨í„´ì˜ í´ë˜ìŠ¤ë¥¼ Kotlinìœ¼ë¡œ ì‘ì„±í•´ë³´ì.</font></strong><br /></p>

<p>â‘  ìš°ì„  modelsíŒ¨í‚¤ì§€ë¥¼ ì‘ì„±ì„ í•˜ê³ , ê·¸ ì•ˆì— Userë¼ëŠ” data classë¥¼ ì‘ì„±í•´ì¤€ë‹¤. <br />
â‘¡ ë‹¤ìŒìœ¼ë¡œ ExampleSingletonì„ ì´ë¦„ìœ¼ë¡œ í•˜ëŠ” Objectí´ë˜ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤. ì´ í´ë˜ìŠ¤ ì•ˆì—ëŠ” ì•ì„œ ì‘ì„±í•œ Userí´ë˜ìŠ¤ë¥¼ ì•„ë˜ì™€ ê°™ì´ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val singletonUser: User by lazy {
  User("email@gmail.com", "username", "image.png")
}
</code></pre></div></div>

<p><strong>lazyí‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ì„œ ë³€ìˆ˜ë¥¼ ìœ„ì„í•˜ë©´ ì‹¤ì œë¡œ í•´ë‹¹ ì†ì„±ì´ í˜¸ì¶œë˜ì„œ ì‚¬ìš©ë ë•Œ, ì´ˆê¸°í™”ê°€ ëœë‹¤.<br />
(í´ë˜ìŠ¤ê°€ ì¸ìŠ¤í„´ìŠ¤í™”ë˜ëŠ” íƒ€ì´ë°ì—ëŠ” í•´ë‹¹ ì†ì„±ì€ ë©”ëª¨ë¦¬ìƒì— ì´ˆê¸°í™”ë˜ì§€ ì•ŠëŠ”ë‹¤) </strong><br /></p>

<p>â‘¢ MainActivityì˜ onCreate ë©”ì†Œë“œ ë‚´ì—ì„œ Singletoní´ë˜ìŠ¤ ë‚´ë¶€ì—ì„œ ì‘ì„±í•œ singletonUser ë³€ìˆ˜ì˜ hashCodeë¥¼ í™•ì¸í•´ì„œ ì‹¤ì œ í™”ë©´ì˜ configuration(portrait/landscape)ê°€ ë³€ê²½ì´ ë˜ì—ˆì„ë•Œ, ê°™ì€ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ë°˜í™˜í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•´ë³¸ë‹¤. <br /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>println("DEBUG: ${ExampleSingleton.singletonUser.hashCode()}")
</code></pre></div></div>

<p>ì•„ë˜ì™€ ê°™ì´ í™”ë©´ì˜ configurationì„ ë°”ê¿¨ì„ë•Œ, ë§¤ë²ˆ ê°™ì€ hashCodeë¥¼ ë°˜í™˜í•¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.<br /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>D/EGL_emulation: eglMakeCurrent: 0xdb71a480: ver 3 0 (tinfo 0xdb70f7a0)
I/System.out: DEBUG: -1198862957
D/EGL_emulation: eglMakeCurrent: 0xdb71a480: ver 3 0 (tinfo 0xdb70f7a0)
D/EGL_emulation: eglMakeCurrent: 0xdb71a480: ver 3 0 (tinfo 0xdb70f7a0)
I/System.out: DEBUG: -1198862957
D/EGL_emulation: eglMakeCurrent: 0xdb71a480: ver 3 0 (tinfo 0xdb70f7a0)
</code></pre></div></div>

<p>â‘£ ë‹¤ìŒìœ¼ë¡œ, api íŒ¨í‚¤ì§€ë¥¼ ì‘ì„±í•˜ê³ , MyRetrofitBuilder(Objectí´ë˜ìŠ¤)ì™€ ApiService ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‘ì„±í•´ë³¼ ê²ƒì´ë‹¤. <br />
MyRetrofitBuilderí´ë˜ìŠ¤ë¥¼ Objectí´ë˜ìŠ¤ íƒ€ì…ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ì´ìœ ëŠ” Kotlinì—ì„œëŠ” Objectí´ë˜ìŠ¤ë¡œ ì‘ì„±í•œë‹¤ëŠ” ì˜ë¯¸ê°€ ë°”ë¡œ â€˜Singletonâ€™ìœ¼ë¡œ ì‘ì„±í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì´ê¸° ë•Œë¬¸ì´ë‹¤. ApiServiceì¸í„°í˜ì´ìŠ¤ì—ì„œëŠ” Retrofitì„ ì‚¬ìš©í•´ í†µì‹ ìƒìœ¼ë¡œí„° ë°ì´í„°ë¥¼ ì·¨ë“í•˜ëŠ” ë©”ì†Œë“œë¥¼ ì‘ì„±í•  ê²ƒì´ë‹¤.<br />
<strong><font color="Blue">MyRetrofitBuilder.kt</font></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>object MyRetrofitBuilder {

    const val BASE_URL = "https://open-api.xyz/"

    // Singleton Retrofit builder
    val retrofitBuilder: Retrofit.Builder by lazy {
      Retrofit.Builder()
      .baseUrl(BASE_URL)
      .addConverterFactory(GsonConverterFactory.create())
      // ì„œë²„ë¡œë¶€í„° í˜¸ì¶œë˜ëŠ” ë°ì´í„°ì˜ í˜•ì‹ì€ JSONí˜•íƒœì´ë¯€ë¡œ, ì´ë¥¼ Convertí•  Converterê°€ í•„ìš”í•˜ë‹¤.
      // Gson Converter = JSON objcet -&gt; Java object
    }

    // Singleton apiService (Network request)
    val apiService: ApiService by lazy {
      retrofitBuilder
      .build()
      .create(ApiService::class.java)
    }

}
</code></pre></div></div>

<p><strong><font color="Blue">ApiService.kt</font></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interface ApiService {

    @GET("placeholder/user/{userId}")
    // ì—¬ê¸°ì„œ ì‚¬ìš©ë˜ëŠ” suspend funì€ 'coroutine'ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ funì´ë‹¤.
    // use 'coroutine' fun return the date from network.
    suspend fun getUser(
        @Path("userId") userId: String
    ): User
}
</code></pre></div></div>

<p>â€˜suspend funâ€™ì„ ì‚¬ìš©í•˜ë©´ â€˜coroutineâ€™ì„ ì‚¬ìš©í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤. <br /></p>

<p>â‘¤ <strong>Repository</strong>íŒ¨í‚¤ì§€ ì¶”ê°€í•˜ê³ , Repository Objectí´ë˜ìŠ¤ ì‘ì„±í•˜ê¸°.<br /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>object Repository{

    var job: CompletableJob? = null

    fun getUser(userId: String): LiveData&lt;User&gt; {
      // jobì„ ì´ˆê¸°í™”ì‹œì¼œì¤€ë‹¤.
      job = Job()
      return object: LiveData&lt;User&gt;(){
          override fun onActive(){
            super.onActive()
            // ìš°ì„  jobì´ nullì¸ì§€ ì•„ë‹Œì§€ ê²€ì‚¬ë¥¼ í•œë‹¤.
            job?.let{ theJob-&gt;
              // jobì´ nullì´ ì•„ë‹Œê²½ìš°, ì‹¤í–‰ì„ í•œë‹¤.
              // IO(Dispatchers)+theJobìœ¼ë¡œ ìœ ë‹ˆí¬í•œ CoroutineScopeë¥¼ background threadì— ìƒì„±ì„ í•œë‹¤.
              CoroutineScope(IO+theJob).launch{
                val user = MyRetrofitBuilder.apiService.getUser(userId)
                // live dataë¥¼ background threadì— í•´ì¤„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ,
                // ìš°ì„  MAIN ìŠ¤ë ˆë“œë¡œ ì „í™˜ì„ í•˜ê³ , live dataë¥¼ settingí•´ì£¼ì–´ì•¼ í•œë‹¤.
                withContext(Main){
                  value = user
                  theJob.complete()
                }
              }
            }
          }
      }  
    }
    // jobì„ calcelí•˜ëŠ” methodì´ë‹¤.
    fun cancelJob(){
        job?.cancel()
    }
}
</code></pre></div></div>

<p>â‘¥ MainViewModel í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤.<br /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class MainViewModel : ViewModel() {
    private val _userId: MutableLiveData&lt;String&gt; = MutableLiveData()

    // Transformations _userIdì— ë³€í™”ê°€ ìƒê¸°ë©´ .switchMap ì´ trigger ë˜ê³  {}ì•ˆì— ì½”ë“œê°€ ì‹¤í–‰ëœë‹¤.
    val user: LiveData&lt;User&gt; = Transformations
          .switchMap(_userId){
              // ê¸°ì¡´ _userIdì— ë³€í™”ê°€ ìƒê²¼ìœ¼ë‹ˆ, ì—…ë°ì´íŠ¸ë¥¼ í•´ì£¼ì–´ì•¼ í•œë‹¤.
              // ë”°ë¼ì„œ, Repository.getUserë¥¼ í†µí•´ì„œ ìƒˆë¡œìš´ uerIdë¥¼ ì·¨ë“í•´ì„œ ìœ„ì— Stringë³€ìˆ˜ë¥¼ ì´ˆê¸°í™” ì‹œì¼œì¤€ë‹¤.
              Repository.getUser(it)
          }

    fun setUserId(userId: String){
         val update = userId

         // í˜„ì¬ì˜ userIdê°€ ì´ë¯¸ setting ë˜ì—ˆë‹¤ë©´ ì¢…ë£Œí•œë‹¤.
         if(_userId.value == update){
              return
          }
         // ê¸°ì¡´ì˜ userIdë¥¼ updateëœ ìƒˆë¡œìš´ userIdë¡œ ì´ˆê¸°í™”ì‹œí‚¨ë‹¤.
          _userId.value = update
    }  

    // Repositoryì—ì„œ ì‘ì„±í•œ cancelJobs() ë©”ì†Œë“œë¥¼ viewModelí´ë˜ìŠ¤ì˜ cancelJobs()ë©”ì†Œë“œ ì•ˆì— ì‘ì„±í•´ì¤€ë‹¤.
    fun cancelJobs(){
        Repository.cancelJobs()
    }    
}
</code></pre></div></div>

<p>â‘¦ MainActivityì—ì„œ ì‘ì„±í•œ MainViewModelí´ë˜ìŠ¤ì˜ instanceë¥¼ ì‘ì„±í•´ì„œ, Observe(ë³€ìˆ˜ì˜ ë³€í™”ê°€ ê°ì§€ë˜ì—ˆì„ë•Œ)ë¥¼ ì‘ì„±í•œë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class MainActivity : AppCompatActivity() {

    lateinit var viewModel: MainViewModel

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        viewModel = ViewModelProvider(this).get(MainViewModel::class.java)

        viewModel.user.observe(this, Observer {user -&gt;
            println("DBUG: $user")
        })
        viewModel.setUserId("1")
    }

    override fun onDestroy() {
        super.onDestroy()
        viewModel.cancelJobs()
    }
} &lt;br&gt;
</code></pre></div></div>

<p>â€» ë…¸íŠ¸í•„ê¸° ìº¡ì³ <br />
<img src="/images/android/MVVM Kotlin note.png" alt="blog capture" title="capture img" width="600" /><br /></p>

<p>â€» ì‹¤ìŠµí–ˆë˜ Repository : <a href="https://github.com/MikeHyungiLee/MVVMArchitectureKotlin">https://github.com/MikeHyungiLee/MVVMArchitectureKotlin</a></p>

<h3 id="ì „ì²´ì ì¸-í•™ìŠµë‚´ìš©ì„-ë³µìŠµí•œë‹¤">ì „ì²´ì ì¸ í•™ìŠµë‚´ìš©ì„ ë³µìŠµí•œë‹¤.<br /></h3>
<ol>
  <li><br /></li>
</ol>
:ET